---
title: æ·˜å®é¢è¯•å®˜ğŸ‘¤ï¼šä¼˜æƒ åˆ¸ç³»ç»Ÿè¯¥å¦‚ä½•è®¾è®¡ï¼Ÿ
shortTitle: å¤§å‚çš„ä¼˜æƒ åˆ¸ç³»ç»Ÿæ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ
description: å¤§å‚çš„ä¼˜æƒ åˆ¸ç³»ç»Ÿæ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ
category:
  - æ±‚èŒé¢è¯•
tag:
  - é¢è¯•é¢˜&å…«è‚¡æ–‡
head:
  - - meta
    - name: keywords
      content: Java,java,é¢è¯•é¢˜,å…«è‚¡æ–‡,ä¼˜æƒ åˆ¸
---


## 1 Scenario åœºæ™¯

ç”µå•†å¤§å‚å¸¸è§ä¿ƒé”€æ‰‹æ®µï¼š

*   ä¼˜æƒ åˆ¸
*   æ‹¼å›¢
*   ç ä»·
*   è€å¸¦æ–°

### **1.1 ä¼˜æƒ åˆ¸çš„ç§ç±»**

*   æ»¡å‡åˆ¸
*   ç›´å‡åˆ¸
*   æŠ˜æ‰£åˆ¸

### **1.2 ä¼˜æƒ åˆ¸ç³»ç»Ÿçš„æ ¸å¿ƒæµç¨‹**

#### **1.2.1 å‘åˆ¸**

å‘åˆ¸çš„æ–¹å¼ï¼šåŒæ­¥å‘é€ or å¼‚æ­¥å‘é€

#### **1.2.2 é¢†åˆ¸**

*   è°èƒ½é¢†ï¼Ÿ

æ‰€æœ‰ç”¨æˆ· or æŒ‡å®šçš„ç”¨æˆ·

*   é¢†å–ä¸Šé™

ä¸€ä¸ªä¼˜æƒ åˆ¸æœ€å¤šèƒ½é¢†å–å¤šå°‘å¼ ï¼Ÿ

*   é¢†å–æ–¹å¼

ç”¨æˆ·ä¸»åŠ¨é¢†å– or è‡ªåŠ¨å‘æ”¾è¢«åŠ¨é¢†å–

#### **1.2.3 ç”¨åˆ¸**

*   ä½œç”¨èŒƒå›´

å•†å“ã€å•†æˆ·ã€ç±»ç›®

*   è®¡ç®—æ–¹å¼

æ˜¯å¦äº’æ–¥ã€æ˜¯å¦è¾¾åˆ°é—¨æ§›ç­‰

### **1.3 éœ€æ±‚æ‹†è§£**

#### **1.3.1 å•†å®¶ä¾§**

*   åˆ›å»ºä¼˜æƒ åˆ¸
*   å‘é€ä¼˜æƒ åˆ¸

#### **1.3.2 ç”¨æˆ·ä¾§**

*   é¢†å–ä¼˜æƒ åˆ¸
*   ä¸‹å•
*   ä½¿ç”¨ä¼˜æƒ åˆ¸
*   æ”¯ä»˜

## **2 Service æœåŠ¡**

### **2.1 æœåŠ¡ç»“æ„è®¾è®¡**

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-daadyhqjtsrhsjd-cdf44a4a-f648-49f0-bebe-686c4a66d2fd.jpg)

### **2.2 ä¼˜æƒ åˆ¸ç³»ç»Ÿè®¾è®¡æŠ€æœ¯éš¾ç‚¹**

*   åˆ¸çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä½¿ç”¨åˆ¸çš„è¿‡ç¨‹ä¼šå‡ºç°çš„åˆ†å¸ƒå¼é—®é¢˜åˆ†æ?
*   å¦‚ä½•é˜²æ­¢è¶…å‘?
*   å¦‚ä½•å¤§æ‰¹é‡ç»™ç”¨æˆ·å‘åˆ¸?
*   å¦‚ä½•é™åˆ¶åˆ¸çš„ä½¿ç”¨æ¡ä»¶?
*   å¦‚ä½•é˜²æ­¢ç”¨æˆ·é‡å¤é¢†åˆ¸?


## 3 Storageå­˜å‚¨

### **3.1 è¡¨å•è®¾è®¡**

#### **åˆ¸æ‰¹æ¬¡ï¼ˆåˆ¸æ¨¡æ¿ï¼‰ï¼Œcoupon\_batch**

æŒ‡ä¸€æ‰¹ä¼˜æƒ åˆ¸çš„æŠ½è±¡ã€æ¨¡æ¿ï¼ŒåŒ…å«ä¼˜æƒ åˆ¸çš„å¤§éƒ¨åˆ†å±æ€§ã€‚

å¦‚å•†å®¶åˆ›å»ºäº†ä¸€æ‰¹ä¼˜æƒ åˆ¸ï¼Œå…±1000å¼ ï¼Œä½¿ç”¨æ—¶é—´ä¸º2022-11-11 00:00:00 ~ 2022-11-11 23:59:59ï¼Œè§„å®šåªæœ‰æ•°ç ç±»ç›®å•†å“æ‰èƒ½ä½¿ç”¨ï¼Œæ»¡100å‡50ã€‚

#### **åˆ¸**

å‘æ”¾åˆ°ç”¨æˆ·çš„ä¸€ä¸ªå®ä½“ï¼Œå·²ä¸ç”¨æˆ·ç»‘å®šã€‚

å¦‚å°†æŸæ‰¹æ¬¡çš„ä¼˜æƒ åˆ¸ä¸­çš„ä¸€å¼ å‘é€ç»™æŸä¸ªç”¨æˆ·ï¼Œæ­¤æ—¶ä¼˜æƒ åˆ¸å±äºç”¨æˆ·ã€‚

#### **è§„åˆ™**

ä¼˜æƒ åˆ¸çš„ä½¿ç”¨æœ‰è§„åˆ™å’Œæ¡ä»¶é™åˆ¶ï¼Œæ¯”å¦‚æ»¡100å‡50åˆ¸ï¼Œéœ€è¦è¾¾åˆ°é—¨æ§›é‡‘é¢100å…ƒæ‰èƒ½ä½¿ç”¨ã€‚

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-daadyhqjtsrhsjd-638df6ed-12f8-4a20-8c58-89051bc9376a.jpg)

**åˆ¸æ‰¹æ¬¡è¡¨ coupon\_batch**

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-daadyhqjtsrhsjd-c4d8f639-328b-42b9-94b0-5e15b8eee784.jpg)

**è§„åˆ™è¡¨ ruleï¼š**

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-daadyhqjtsrhsjd-b2383938-ffbc-4686-808c-908ab11e4b2b.jpg)

**è§„åˆ™å†…å®¹ï¼š**

```
{ 
  threshold: 5.01 // ä½¿ç”¨é—¨æ§› 
  amount: 5 // ä¼˜æƒ é‡‘é¢ 
  use_range: 3 // ä½¿ç”¨èŒƒå›´ï¼Œ0â€”å…¨åœºï¼Œ1â€”å•†å®¶ï¼Œ2â€”ç±»åˆ«ï¼Œ3â€”å•†å“ 
  commodity_id: 10 // å•†å“ id 
  receive_count: 1 // æ¯ä¸ªç”¨æˆ·å¯ä»¥é¢†å–çš„æ•°é‡ 
  is_mutex: true // æ˜¯å¦äº’æ–¥ï¼Œtrue è¡¨ç¤ºäº’æ–¥ï¼Œfalse è¡¨ç¤ºä¸äº’æ–¥ 
  receive_started_at: 2020-11-1 00:08:00 // é¢†å–å¼€å§‹æ—¶é—´ 
  receive_ended_at: 2020-11-6 00:08:00 // é¢†å–ç»“æŸæ—¶é—´ 
  use_started_at: 2020-11-1 00:00:00 // ä½¿ç”¨å¼€å§‹æ—¶é—´ 
  use_ended_at: 2020-11-11 11:59:59 // ä½¿ç”¨ç»“æŸæ—¶é—´ 
}
```


**ä¼˜æƒ åˆ¸è¡¨ couponï¼š**

```

create table t_coupon
(
    coupon_id     int          null comment 'åˆ¸IDï¼Œä¸»é”®',
    user_id       int          null comment 'ç”¨æˆ·ID',
    batch_id      int          null comment 'æ‰¹æ¬¡ID',
    status        int          null comment '0-æœªä½¿ç”¨ã€1-å·²ä½¿ç”¨ã€2-å·²è¿‡æœŸã€3-å†»ç»“',
    order_id      varchar(255) null comment 'å¯¹åº”è®¢å•ID',
    received_time datetime     null comment 'é¢†å–æ—¶é—´',
    validat_time  datetime     null comment 'æœ‰æ•ˆæ—¥æœŸ',
    used_time     datetime     null comment 'ä½¿ç”¨æ—¶é—´'
);
```


### **3.2 å»ºåˆ¸**

**1ã€æ–°å»ºè§„åˆ™**

```
INSERT INTO rule (name, type, rule_content) 
VALUES(â€œæ»¡å‡è§„åˆ™â€, 0, '{ 
                         threshold: 100 
                         amount: 10 
                         ...... 
                       }');
```

**2ã€æ–°å»ºä¼˜æƒ åˆ¸æ‰¹æ¬¡**

```
INSERT INTO coupon\_batch (coupon\_name, rule\_id, total\_count ) 
VALUES(â€œåŠ³æ–¯è±æ–¯5å…ƒä»£é‡‘åˆ¸â€, 1010, 10000);
```




### **3.3 å‘åˆ¸**

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-daadyhqjtsrhsjd-066459b1-1271-468e-9e45-c409b6298144.jpg)

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-daadyhqjtsrhsjd-a448c453-8b50-4af8-a913-bda03a6c6f97.jpg)

##### **å¦‚ä½•ç»™å¤§é‡ç”¨æˆ·å‘åˆ¸ï¼Ÿ**

å¼‚æ­¥å‘é€ï¼

##### **è§¦è¾¾ç³»ç»Ÿ**

*   çŸ­ä¿¡ã€é‚®ä»¶

å¯é€šè¿‡è°ƒç”¨ç¬¬ä¸‰æ–¹æ¥å£çš„æ–¹å¼å®ç°

*   ç«™å†…ä¿¡

é€šè¿‡æ•°æ®åº“æ’å…¥è®°å½•æ¥å®ç°

**ä¿¡æ¯è¡¨ message**

```
create table t_message
(
    id         int null comment 'ä¿¡æ¯ID',
    send_id    int null comment 'å‘é€è€…id',
    rec_id     int null comment 'æ¥å—è€…id',
    content    vachar(255) comment 'ç«™å†…ä¿¡å†…å®¹',
    is_read    int null comment 'æ˜¯å¦å·²è¯»',
    send_time  datetime comment 'å‘é€æ—¶é—´'
)
comment 'ä¿¡æ¯è¡¨';
```

å…ˆè€ƒè™‘ç”¨æˆ·é‡å¾ˆå°‘çš„æƒ…å†µï¼Œå•†å®¶è¦ç»™æ‰€æœ‰äººå‘ç«™å†…ä¿¡ï¼Œåˆ™å…ˆéå†ç”¨æˆ·è¡¨ï¼Œå†æŒ‰ç…§ç”¨æˆ·è¡¨ä¸­çš„æ‰€æœ‰ç”¨æˆ·ä¾æ¬¡å°†ç«™å†…ä¿¡æ’å…¥åˆ° message è¡¨ä¸­ã€‚è¿™æ ·ï¼Œå¦‚æœæœ‰100ä¸ªç”¨æˆ·ï¼Œåˆ™ç¾¤å‘ä¸€æ¡ç«™å†…ä¿¡è¦æ‰§è¡Œ100ä¸ªæ’å…¥æ“ä½œã€‚

#### **ç³»ç»Ÿç”¨æˆ·æ•°å¢åŠ åˆ°wçº§**

å‘ä¸€æ¡ç«™å†…ä¿¡ï¼Œå°±å¾—é‡å¤æ’å…¥ä¸Šä¸‡æ¡æ•°æ®ã€‚è€Œä¸”è¿™ä¸Šä¸‡æ¡æ•°æ®çš„ content ä¸€æ ·ï¼å‡è®¾ä¸€æ¡ç«™å†…ä¿¡å 100Kï¼Œå‘ä¸€æ¬¡ç«™å†…ä¿¡å°±è¦æ¶ˆè€—åå‡ Mã€‚å¯¹æ­¤ï¼Œå¯å°†åŸæ¥çš„è¡¨æ‹†æˆä¸¤ä¸ªè¡¨ï¼š

**ä¿¡æ¯è¡¨ message**

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-daadyhqjtsrhsjd-19c6ce5d-8e83-4552-902d-5d28cd17a7be.jpg)

**ä¿¡æ¯å†…å®¹è¡¨ message\_content**

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-daadyhqjtsrhsjd-e04b414f-6b41-4882-8324-208715b52284.jpg)

#### **å‘ä¸€å°ç«™å†…ä¿¡çš„æ­¥éª¤**

1.  å¾€ message\_content æ’å…¥ç«™å†…ä¿¡çš„å†…å®¹
2.  åœ¨ message è¡¨ä¸­ï¼Œç»™æ‰€æœ‰ç”¨æˆ·æ’å…¥ä¸€æ¡è®°å½•ï¼Œæ ‡è¯†æœ‰ä¸€å°ç«™å†…ä¿¡


#### **åƒwçº§ç”¨æˆ·æ•°**

è¿™å°±æœ‰ã€éæ´»è·ƒç”¨æˆ·ã€‘çš„é—®é¢˜ï¼Œå‡è®¾æ³¨å†Œç”¨æˆ·ä¸€åƒä¸‡ï¼Œæ ¹æ®äºŒå…«åŸåˆ™ï¼Œå…¶ä¸­æ´»è·ƒç”¨æˆ·å 20%ã€‚è‹¥é‡‡ç”¨ä¸Šé¢æ‹†æˆä¸¤ä¸ªè¡¨çš„æƒ…å†µï¼Œå‘ä¸€å°â€œç«™å†…ä¿¡â€ï¼Œå¾—æ‰§è¡Œä¸€åƒä¸‡ä¸ªæ’å…¥æ“ä½œã€‚å¯èƒ½å‰©ä¸‹80%ç”¨æˆ·åŸºæœ¬éƒ½ä¸ä¼šå†ç™»å½•ï¼Œå…¶å®åªéœ€å¯¹å…¶ä¸­20%ç”¨æˆ·æ’å…¥æ•°æ®ã€‚

**ä¿¡æ¯è¡¨ messageï¼š**

```
create table t_message
(
    id         int null comment 'ä¿¡æ¯ ID',
    # send_id    int null comment 'å‘é€è€… id', å»é™¤è¯¥å­—æ®µ
    rec_id     int null comment 'æ¥å—è€… id',
    message_id int null comment 'å¤–é”®ï¼Œä¿¡æ¯å†…å®¹',
    is_read    int null comment 'æ˜¯å¦å·²è¯»'
)
    comment 'ä¿¡æ¯è¡¨';
create table t_message_content
(
    id        int          null comment 'ä¿¡æ¯å†…å®¹id',
    send_id     int         null comment 'å‘é€è€…id',
    content   varchar(255) null comment 'å†…å®¹',
    send_time datetime     null comment 'å‘é€æ—¶é—´'
);
```



#### **ç”¨æˆ·ä¾§æ“ä½œ**

ç™»å½•åï¼Œé¦–å…ˆæŸ¥è¯¢ message\_content ä¸­çš„é‚£äº›æ²¡æœ‰åœ¨ message ä¸­æœ‰è®°å½•çš„æ•°æ®ï¼Œè¡¨ç¤ºæ˜¯æœªè¯»çš„ç«™å†…ä¿¡ã€‚åœ¨æŸ¥é˜…ç«™å†…ä¿¡çš„å†…å®¹æ—¶ï¼Œå†å°†ç›¸å…³çš„è®°å½•æ’å…¥ messageã€‚

#### **ç³»ç»Ÿä¾§æ“ä½œ**

å‘ç«™å†…ä¿¡æ—¶ï¼š

*   åªåœ¨ message\_content æ’å…¥ç«™å†…ä¿¡çš„ä¸»ä½“å†…å®¹
*   message ä¸æ’å…¥è®°å½•

#### **ç»™ 10W ç”¨æˆ·å‘åˆ¸**

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-daadyhqjtsrhsjd-e6134270-a52f-4579-a200-e0c0e4c13c82.jpg)

æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿé‡å¤æ¶ˆè´¹ï¼Œå¯¼è‡´è¶…å‘ï¼

1.  è¿è¥æä¾›æ»¡è¶³æ¡ä»¶çš„ç”¨æˆ·æ–‡ä»¶ï¼Œä¸Šä¼ åˆ°å‘åˆ¸ç®¡ç†åå°å¹¶é€‰æ‹©è¦å‘é€çš„ä¼˜æƒ åˆ¸
2.  ç®¡ç†æœåŠ¡å™¨æ ¹æ®ã€ç”¨æˆ·IDã€‘ã€ã€åˆ¸æ‰¹æ¬¡IDã€‘ç”Ÿæˆæ¶ˆæ¯ï¼Œå‘é€åˆ°MQ
3.  ä¼˜æƒ åˆ¸æœåŠ¡å™¨æ¶ˆè´¹æ¶ˆæ¯

```
# è®°ä½ä½¿ç”¨äº‹åŠ¡å“¦ï¼
INSERT INTO coupon (user_id, coupon_idï¼Œbatch_id)
  VALUES(1001, 66889, 1111);

UPDATE coupon_batch SET total_count = total_count - 1,
                          assign_count = assign_count + 1
                      WHERE batch_id = 1111 AND total_count > 0;
```

### **3.4 é¢†åˆ¸**

#### æ­¥éª¤

1.  æ ¡éªŒä¼˜æƒ åˆ¸ä½™é‡

```
SELECT total_count FROM coupon_batch
WHERE batch_id = 1111;
```



2.  æ–°å¢ä¼˜æƒ åˆ¸ç”¨æˆ·è¡¨ï¼Œæ‰£å‡ä½™é‡

```
# æ³¨æ„äº‹åŠ¡ï¼
INSERT INTO coupon (user_id, coupon_idï¼Œbatch_id)
  VALUES(1001, 66889, 1111); 

UPDATE coupon_batch SET total_count = total_count - 1,
                          assign_count = assign_count + 1
                      WHERE batch_id = 1111 AND total_count > 0;
```



ç”¨æˆ·é¢†åˆ¸è¿‡ç¨‹ä¸­ï¼Œå…¶å®ä¹Ÿä¼šå‡ºç°ç±»ä¼¼ç§’æ€åœºæ™¯ã€‚ç§’æ€åœºæ™¯ä¸‹ä¼šæœ‰å“ªäº›é—®é¢˜ï¼Œå¦‚ä½•è§£å†³ï¼Ÿ

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-daadyhqjtsrhsjd-8367d61b-2a12-4225-9fc2-586a1baac77d.jpg)

#### **ç”¨æˆ·é‡å¤é¢†å–æˆ–å¤šé¢†**

Redis æ•°æ®æ ¡éªŒï¼

1.  é¢†åˆ¸å‰ï¼Œå…ˆæŸ¥ç¼“å­˜

```
# åˆ¤æ–­æˆå‘˜å…ƒç´ æ˜¯å¦æ˜¯é›†åˆçš„æˆå‘˜
```
```
SISMEMBER KEY VALUE
SISMEMBER batch_id:1111:user_id 1001
```

2.  é¢†åˆ¸
3.  é¢†åˆ¸åï¼Œæ›´æ–°ç¼“å­˜

```
# å°†ä¸€æˆ–å¤šä¸ªæˆå‘˜å…ƒç´ åŠ å…¥åˆ°é›†åˆä¸­ï¼Œå·²ç»å­˜åœ¨äºé›†åˆçš„æˆå‘˜å…ƒç´ å°†è¢«å¿½ç•¥
SADD KEY VALUE1......VALUEN
SADD batch_id:1111:user_id 1001
```

## **3.5 ç”¨åˆ¸**

ä½•æ—¶æ ¡éªŒä¼˜æƒ åˆ¸ä½¿ç”¨è§„åˆ™ï¼Ÿ

1.  ç¡®è®¤è®¢å•ï¼ˆâˆšï¼‰
2.  æäº¤è®¢å•
3.  ç«‹å³ä»˜æ¬¾

ç¡®è®¤è®¢å•é¡µï¼Œå¯¹ä¼˜æƒ åˆ¸è¿›è¡Œæ ¡éªŒï¼š

*   åˆ¤æ–­æ˜¯å¦è¿‡æœŸ
*   åˆ¤æ–­é€‚ç”¨èŒƒå›´
*   åˆ¤æ–­æ˜¯å¦è¾¾åˆ°é—¨æ§›
*   åˆ¤æ–­æ˜¯å¦äº’æ–¥


### **è¿”å›å¯ç”¨åˆ¸**

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-daadyhqjtsrhsjd-182ea6b8-4702-4f01-b3dd-f9636815863f.jpg)

```
SELECT batch_id FROM coupon WHERE user_id = 1001 AND status = 0;
SELECT rule_id FROM coupon_batch WHERE batch_id = 1111;
SELECT name, type, rule_content FROM rule WHERE rule_id = 1010;
```

### é€‰æ‹©å¯ç”¨åˆ¸ï¼Œå¹¶è¿”å›ç»“æœ

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-daadyhqjtsrhsjd-3d50a63e-2c1a-413b-9143-f808dcc4e0da.jpg)

### **åŒæ—¶æ“ä½œå¤šä¸ªæœåŠ¡ï¼Œå¦‚ä½•ä¿è¯ä¸€è‡´æ€§ï¼Ÿ**

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-daadyhqjtsrhsjd-3b30f2df-fd77-4265-b655-31a82028505e.jpg)

### **è¡¨è®¾è®¡**

**ä¼˜æƒ åˆ¸æ“ä½œè®°å½•è¡¨ Coupon\_opt\_record**

```
create table t_coupon_opt_record
(
    user_id     int      null comment 'ç”¨æˆ·id',
    coupon_id   int      null comment 'ä¼˜æƒ åˆ¸id',
    operating   int      null comment 'æ“ä½œï¼Œ0-é”å®šã€1-æ ¸é”€ã€2-è§£é”',
    operated_at datetime null comment 'æ“ä½œæ—¶é—´'
);
```

TCCï¼ŒTry-Confirm-Cancelï¼Œç›®å‰åˆ†å¸ƒå¼äº‹åŠ¡ä¸»æµè§£å†³æ–¹æ¡ˆã€‚

1.  é˜¶æ®µä¸€ï¼šTry

å¯¹èµ„æºè¿›è¡Œå†»ç»“ï¼Œé¢„ç•™ä¸šåŠ¡èµ„æº

åˆ›å»ºè®¢å•æ—¶ï¼Œå°†ä¼˜æƒ åˆ¸çŠ¶æ€æ”¹ä¸º â€œå†»ç»“â€

2.  é˜¶æ®µäºŒï¼šConfirm

ç¡®è®¤æ‰§è¡Œä¸šåŠ¡æ“ä½œï¼ŒåšçœŸæ­£æäº¤ï¼Œå°†ç¬¬ä¸€æ­¥Tryä¸­å†»ç»“çš„èµ„æºï¼ŒçœŸæ­£æ‰£å‡

è®¢å•æ”¯ä»˜æˆåŠŸï¼Œå°†ä¼˜æƒ åˆ¸çŠ¶æ€æ”¹ä¸º â€œå·²ä½¿ç”¨â€

3.  é˜¶æ®µä¸‰ï¼šCancel

å–æ¶ˆæ‰§è¡Œä¸šåŠ¡æ“ä½œï¼Œå–æ¶ˆTryé˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æº

æ”¯ä»˜å¤±è´¥/è¶…æ—¶æˆ–è®¢å•å…³é—­æƒ…å†µï¼Œå°†ä¼˜æƒ åˆ¸çŠ¶æ€æ”¹ä¸º â€œæœªä½¿ç”¨â€

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-daadyhqjtsrhsjd-c6a77fdf-4f4d-4082-92a7-c2cd11aba686.jpg)


## 4 Scale æ‰©å±•

### **4.1 å¿«è¿‡æœŸåˆ¸æé†’**

#### **å®šæ—¶æ‰«åˆ¸è¡¨**

ç¼ºç‚¹ï¼šæ‰«ææ•°æ®é‡å¤ªå¤§ï¼Œéšç€å†å²æ•°æ®è¶Šæ¥è¶Šå¤šï¼Œä¼šå½±å“çº¿ä¸Šä¸»ä¸šåŠ¡ï¼Œæœ€ç»ˆå¯¼è‡´æ…¢SQLã€‚

#### **å»¶æ—¶æ¶ˆæ¯**

ç¼ºç‚¹ï¼šæœ‰äº›åˆ¸çš„æœ‰æ•ˆæ—¶é—´å¤ªé•¿äº†(30å¤©)ä»¥ä¸Šï¼Œæœ‰å¯èƒ½é€ æˆå¤§é‡ MQ ç§¯å‹

#### **æ–°å¢é€šçŸ¥è¡¨**

ä¼˜ç‚¹ï¼šæ‰«æçš„æ•°æ®é‡å°ï¼Œæ•ˆç‡é«˜ã€‚åˆ é™¤æ— ç”¨çš„å·²é€šçŸ¥çš„æ•°æ®è®°å½•

##### **é€šçŸ¥ä¿¡æ¯è¡¨ï¼ˆnotify\_msgï¼‰è®¾è®¡**

```
create table t_notify_msg
(
    id          bigint auto_increment comment 'è‡ªå¢ä¸»é”®',
    coupon_id   bigint       null comment 'åˆ¸id',
    user_id     bigint       null comment 'ç”¨æˆ·id',
    notify_day  varchar(255) null comment 'éœ€è¦æ‰§è¡Œé€šçŸ¥çš„æ—¥æœŸ',
    notify_type int          null comment 'é€šçŸ¥ç±»å‹ï¼Œ1-è¿‡æœŸæé†’',
    notif_time  timestamp    null comment 'é€šçŸ¥çš„æ—¶é—´ï¼Œåœ¨è¯¥æ—¶é—´æˆ³æ‰€åœ¨å¤©å†…é€šçŸ¥',
    status      int          null comment 'é€šçŸ¥çŠ¶æ€ï¼Œ0-åˆå§‹çŠ¶æ€ã€1-æˆåŠŸã€2-å¤±è´¥',
    constraint t_notify_msg_id_uindex
        unique (id)
);

alter table t_notify_msg
    add primary key (id);
```

**è¿‡æœŸåˆ¸æ**

1.  åœ¨åˆ›å»ºä¼˜æƒ åˆ¸çš„æ—¶å€™å°±å°†éœ€è¦æé†’çš„è®°å½•æ’å…¥æé†’è¡¨ä¸­notify\_msg
2.  æŠŠç”¨æˆ·ID+æ‰¹æ¬¡ID+é€šçŸ¥æ—¥æœŸä½œä¸ºå”¯ä¸€ç´¢å¼•ï¼Œé˜²æ­¢åŒä¸€ä¸ªæ‰¹æ¬¡æœ‰é‡å¤çš„è®°å½•é€šçŸ¥ï¼Œä¿è¯æ¯å¤©åªä¼šè¢«é€šçŸ¥ä¸€æ¬¡
3.  å»ºç«‹notify\_timeï¼Œé€šçŸ¥æ—¶é—´ç´¢å¼•ï¼Œæ¯æ—¥çš„é€šçŸ¥æ‰«æé€šè¿‡è¯¥ç´¢å¼•åˆ—æŸ¥è¯¢ï¼Œé€šè¿‡ç´¢å¼•åˆ—æ¥æé«˜æŸ¥è¯¢æ•ˆç‡
4.  é€šçŸ¥å®Œæˆåè¯¥è¡¨ä¸­çš„æ•°æ®å˜å¤±å»äº†æ„ä¹‰ï¼Œé€šè¿‡å®šæ—¶ä»»åŠ¡å°†è¯¥æ•°æ®åˆ é™¤

### **4.2 æ•°æ®åº“å±‚é¢ä¼˜åŒ– - ç´¢å¼•**

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-daadyhqjtsrhsjd-9e10c3cb-d0af-4b0e-a2f9-3da2fe7e72f1.jpg)

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-daadyhqjtsrhsjd-8df5b954-9e5a-445d-882f-f91616fee662.jpg)

### **4.3 å‘åˆ¸æ¥å£ï¼Œé™æµä¿æŠ¤**

#### **å‰ç«¯é™æµ**

ç‚¹å‡»ä¸€æ¬¡åï¼ŒæŒ‰é’®çŸ­æ—¶é—´å†…ç½®ç°

![](http://cdn.tobebetterjavaer.com/tobebetterjavaer/images/nice-article/weixin-daadyhqjtsrhsjd-d2d8684d-9488-4543-9b2b-8e7559c8e625.jpg)

#### **åç«¯é™æµ**

éƒ¨åˆ†è¯·æ±‚ç›´æ¥è·³è½¬åˆ°ã€ç¹å¿™é¡µã€‘


>å‚è€ƒé“¾æ¥ï¼š[https://mp.weixin.qq.com/s/r9lgiOwV5cw8XmfCBUTcUA](https://mp.weixin.qq.com/s/r9lgiOwV5cw8XmfCBUTcUA)ï¼Œå‡ºå¤„ï¼šJavaEdgeï¼Œæ•´ç†ï¼šmusk

----

  

 

  